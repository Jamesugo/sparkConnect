<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Electrician Profile - SparkConnect</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .profile-header-container {
        background-color: var(--white);
        padding: var(--spacing-xxl) 0;
        border-bottom: 1px solid var(--border-color);
      }

      .profile-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-xl);
      }

      .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: var(--radius-full);
        object-fit: cover;
        border: 4px solid var(--white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .profile-info h1 {
        font-size: var(--font-size-3xl);
        margin-bottom: var(--spacing-xs);
      }

      .profile-meta {
        color: var(--primary-blue);
        font-weight: 500;
        margin-bottom: var(--spacing-sm);
      }

      .profile-stats {
        margin-top: var(--spacing-md);
        color: var(--text-gray);
      }

      .content-section {
        padding: var(--spacing-xxl) 0;
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
      }

      .gallery-item {
        aspect-ratio: 1;
        border-radius: var(--radius-md);
        overflow: hidden;
        background-color: #eee;
      }

      .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
      }

      .gallery-item:hover img {
        transform: scale(1.05);
      }

      .reviews-chart {
        margin-top: var(--spacing-lg);
        max-width: 500px;
      }

      .review-bar {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xs);
        font-size: var(--font-size-sm);
      }

      .bar-bg {
        flex: 1;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .bar-fill {
        height: 100%;
        background-color: var(--primary-blue);
      }
    </style>
  </head>
  <body>
    <!-- Nav rendered by js/nav.js -->
    <nav></nav>

    <div id="profile-content">
      <!-- Rendered by JS -->
    </div>

    <script src="js/data.js"></script>
    <script src="js/nav.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const id = parseInt(urlParams.get("id")) || 1;
      // Ensure API_BASE_URL is defined
      if (typeof API_BASE_URL === "undefined") {
        window.API_BASE_URL =
          window.location.port === "5500" ? "http://127.0.0.1:5000" : "";
      }
      let electrician = null;

      async function initProfile() {
        try {
          electrician = await DataManager.getElectricianById(id);
          if (!electrician) {
            document.getElementById("profile-content").innerHTML =
              "<div class='container' style='padding:50px;'>User not found</div>";
            return;
          }
          await renderProfile();
          loadGalleryImages();
          loadReviews();
        } catch (e) {
          console.error(e);
          document.getElementById("profile-content").innerHTML =
            "<div class='container' style='padding:50px;'>Error loading profile</div>";
        }
      }

      async function renderProfile() {
        const container = document.getElementById("profile-content");

        // Check if current user is admin
        const currentUser = await DataManager.getCurrentUser();
        const isAdmin =
          currentUser && currentUser.email === "admin@sparkconnect.com";

        container.innerHTML = `
                <div class="profile-header-container">
                    <div class="container profile-header">
                        <img src="${
                          electrician.image &&
                          !electrician.image.startsWith("http")
                            ? API_BASE_URL + "/" + electrician.image
                            : electrician.image ||
                              "assets/images/profile_placeholder.jpg"
                        }" alt="${
          electrician.name
        }" class="profile-avatar" onerror="this.onerror=null; this.src='assets/images/profile_placeholder.jpg'">
                        <div class="profile-info">
                            <h1>${electrician.name}</h1>
                            <div class="profile-meta">${
                              electrician.specialty || "Electrician"
                            } â€¢ ${
          electrician.state || "NG"
        } â€¢ Licensed Electrician</div>
                            <div class="profile-stats">â˜… ${
                              electrician.rating || 0
                            } (${electrician.reviews || 0} reviews)</div>
                            ${
                              electrician.email
                                ? `<div style="font-size:0.9rem; color:var(--text-gray); margin-top:5px;">ðŸ“§ ${electrician.email}</div>`
                                : ""
                            }
                            ${
                              electrician.phone
                                ? `<div style="font-size:0.9rem; color:var(--text-gray); margin-top:2px;">ðŸ“ž ${electrician.phone}</div>`
                                : ""
                            }
                            
                            <div style="margin-top: var(--spacing-lg);">
                                <button class="btn btn-primary contact-btn" onclick="contactElectrician()">Contact</button>
                                <button class="btn btn-outline" style="margin-left: 10px;">Share Profile</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container content-section">
                    <section style="margin-bottom: var(--spacing-xxl);">
                        <h2 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-xl);">About Me</h2>
                        <p style="color: var(--text-gray); line-height: 1.6;">${
                          electrician.description || "No description provided."
                        }</p>
                    </section>
                    
                    ${
                      isAdmin
                        ? `<div id="admin-panel" style="margin-top: var(--spacing-xxl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border-color);">
                             <h3 style="color: #dc3545; margin-bottom: var(--spacing-md);">Admin: Danger Zone</h3>
                             <p style="color: var(--text-gray); margin-bottom: var(--spacing-md);">Permanently delete this account and remove all data.</p>
                             <button onclick="deleteAccount(${electrician.id})" class="btn" style="background-color: #dc3545; color: white;">Delete Account</button>
                    </div>`
                        : ""
                    }

                    <section style="margin-bottom: var(--spacing-xxl);">
                        <h2 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-xl);">Gallery</h2>
                        <div id="profile-gallery-grid" class="gallery-grid">
                            <p>Loading gallery...</p>
                        </div>
                    </section>

                    <section>
                        <h2 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-xl);">Reviews</h2>
                        <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
                             <h1 style="font-size: 4rem; font-weight: 700;">${
                               electrician.rating || 0
                             }</h1>
                             <div>
                                <div style="color: var(--secondary-orange);">â˜…â˜…â˜…â˜…â˜…</div>
                                <div style="color: var(--text-gray);">${
                                  electrician.reviews || 0
                                } reviews</div>
                             </div>
                        </div>

                        <!-- Add Review Form -->
                        <div style="background: #f8f9fa; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-xl);">
                            <h3 style="margin-bottom: var(--spacing-md);">Leave a Review</h3>
                            <form id="review-form">
                                <div style="margin-bottom: var(--spacing-md);">
                                    <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 500;">Rating</label>
                                    <div class="star-rating" style="font-size: 2rem; cursor: pointer;">
                                        <span class="star" data-rating="1">â˜†</span>
                                        <span class="star" data-rating="2">â˜†</span>
                                        <span class="star" data-rating="3">â˜†</span>
                                        <span class="star" data-rating="4">â˜†</span>
                                        <span class="star" data-rating="5">â˜†</span>
                                    </div>
                                    <input type="hidden" id="rating-value" required>
                                </div>
                                <div style="margin-bottom: var(--spacing-md);">
                                    <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 500;">Your Name</label>
                                    <input type="text" id="reviewer-name" placeholder="Enter your name" required style="width: 100%; max-width: 400px;">
                                </div>
                                <div style="margin-bottom: var(--spacing-md);">
                                    <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 500;">Comment (Optional)</label>
                                    <textarea id="review-comment" rows="3" placeholder="Share your experience..." style="width: 100%; max-width: 600px;"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Review</button>
                            </form>
                        </div>

                        <!-- Reviews List -->
                        <div id="reviews-list" style="margin-top: var(--spacing-xl);">
                            <!-- Populated by JS -->
                        </div>
                    </section>
                </div>
            `;

        // Re-bind star listeners since DOM changed
        initStarRating();
      }

      function contactElectrician() {
        if (electrician.whatsapp) {
          window.open(electrician.whatsapp, "_blank");
        } else if (electrician.phone) {
          window.location.href = "tel:" + electrician.phone;
        } else if (electrician.email) {
          window.location.href = "mailto:" + electrician.email;
        } else {
          alert("No contact information available for this user.");
        }
      }

      // Admin function to delete account
      async function deleteAccount(userId) {
        if (
          !confirm(
            `Are you sure you want to permanently delete this user account? This action cannot be undone.`
          )
        ) {
          return;
        }

        try {
          await DataManager.deleteUser(userId);
          alert("User account deleted successfully");
          window.location.href = "/electricians.html";
        } catch (err) {
          alert("Failed to delete account: " + err.message);
        }
      }

      // Async Gallery Loader
      function loadGalleryImages() {
        const gallery = electrician.gallery || [];
        const container = document.getElementById("profile-gallery-grid");
        if (!container) return;

        if (gallery.length === 0) {
          container.innerHTML =
            '<p style="color:var(--text-gray);">No work uploaded yet.</p>';
          return;
        }

        // Just use the strings (URLs from server)
        const renderedItems = gallery.map((item) => {
          let src = item.startsWith("http")
            ? item
            : API_BASE_URL
            ? `${API_BASE_URL}/${item}`
            : item;
          let isVideo =
            item.endsWith(".mp4") ||
            item.endsWith(".mov") ||
            item.endsWith(".webm");

          let mediaHtml = "";
          if (isVideo) {
            mediaHtml = `<video src="${src}" style="width:100%; height:100%; object-fit:cover;" controls></video>`;
          } else {
            mediaHtml = `<img src="${src}" style="width:100%; height:100%; object-fit:cover;">`;
          }

          return `<div style="aspect-ratio:1; background: #eee; overflow:hidden; border-radius: 4px;">${mediaHtml}</div>`;
        });
        container.innerHTML = renderedItems.join("");
      }

      // Star Rating Interaction
      function initStarRating() {
        const stars = document.querySelectorAll(".star");
        const ratingInput = document.getElementById("rating-value");
        let selectedRating = 0;

        stars.forEach((star) => {
          star.addEventListener("click", function () {
            selectedRating = parseInt(this.getAttribute("data-rating"));
            ratingInput.value = selectedRating;
            updateStars(selectedRating);
          });

          star.addEventListener("mouseover", function () {
            const hoverRating = parseInt(this.getAttribute("data-rating"));
            updateStars(hoverRating);
          });
        });

        const starRating = document.querySelector(".star-rating");
        if (starRating) {
          starRating.addEventListener("mouseout", function () {
            updateStars(selectedRating);
          });
        }

        window.updateStars = function (rating) {
          stars.forEach((star, index) => {
            if (index < rating) {
              star.textContent = "â˜…";
              star.style.color = "var(--secondary-orange)";
            } else {
              star.textContent = "â˜†";
              star.style.color = "#ccc";
            }
          });
        };
      }

      // Load and display reviews
      function loadReviews() {
        const reviewsListEl = document.getElementById("reviews-list");
        const list = electrician.reviewsList || [];

        if (list.length === 0) {
          reviewsListEl.innerHTML =
            '<p style="color: var(--text-gray); text-align: center;">No reviews yet. Be the first to review!</p>';
          return;
        }

        reviewsListEl.innerHTML = list
          .map(
            (review) => `
          <div style="border-bottom: 1px solid var(--border-color); padding: var(--spacing-lg) 0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
              <div>
                <strong>${review.name}</strong>
                <div style="color: var(--secondary-orange); margin-top: 4px;">${"â˜…".repeat(
                  review.rating
                )}${"â˜†".repeat(5 - review.rating)}</div>
              </div>
              <small style="color: var(--text-gray);">${new Date(
                review.date
              ).toLocaleDateString()}</small>
            </div>
            ${
              review.comment
                ? `<p style="color: var(--text-gray); margin-top: var(--spacing-sm);">${review.comment}</p>`
                : ""
            }
          </div>
        `
          )
          .join("");
      }

      // Submit Review - ASYNC to API
      document.addEventListener("submit", async function (e) {
        if (e.target.id !== "review-form") return;
        e.preventDefault();

        const ratingInput = document.getElementById("rating-value");
        const rating = parseInt(ratingInput.value);
        const name = document.getElementById("reviewer-name").value;
        const comment = document.getElementById("review-comment").value;

        if (!rating) {
          alert("Please select a rating");
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE_URL}/api/electricians/${electrician.id}/review`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                rating: rating,
                name: name,
                comment: comment,
                date: new Date().toISOString(),
              }),
            }
          );

          if (res.ok) {
            alert("Thank you for your review!");
            location.reload();
          } else {
            alert("Failed to submit review");
          }
        } catch (err) {
          console.error(err);
          alert("Error submitting review");
        }
      });

      // Init
      initProfile();
    </script>
  </body>
</html>
