<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - SparkConnect</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .reset-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #eef2f6;
        padding: var(--spacing-md);
      }

      .reset-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xxl);
        width: 100%;
        max-width: 500px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .reset-header {
        margin-bottom: var(--spacing-xl);
        text-align: center;
      }

      .reset-header h1 {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: var(--spacing-md);
      }

      .form-group {
        margin-bottom: var(--spacing-lg);
      }

      .form-group label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: 500;
        color: var(--text-dark);
      }

      .form-actions {
        margin-top: var(--spacing-xl);
      }

      .btn-full {
        width: 100%;
        padding: var(--spacing-md);
        font-size: var(--font-size-base);
      }

      .success-message {
        background-color: #d1fae5;
        border: 1px solid #10b981;
        color: #065f46;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        text-align: center;
      }

      .error-message {
        background-color: #fee2e2;
        border: 1px solid #ef4444;
        color: #991b1b;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Nav rendered by js/nav.js -->
    <nav></nav>

    <div class="reset-container">
      <div class="reset-card">
        <div class="reset-header">
          <h1>Reset Your Password</h1>
          <p style="color: var(--text-gray)">Enter your new password below</p>
        </div>

        <div id="message-container"></div>

        <form id="form-reset-password">
          <div class="form-group">
            <label for="new-password">New Password</label>
            <div class="password-wrapper">
              <input
                type="password"
                id="new-password"
                placeholder="Enter new password"
                required
                minlength="6"
              />
              <button
                type="button"
                class="password-toggle"
                onclick="togglePassword('new-password', this)"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <div class="password-wrapper">
              <input
                type="password"
                id="confirm-password"
                placeholder="Confirm new password"
                required
                minlength="6"
              />
              <button
                type="button"
                class="password-toggle"
                onclick="togglePassword('confirm-password', this)"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-full">
              Reset Password
            </button>
          </div>

          <div style="text-align: center; margin-top: var(--spacing-md)">
            <a href="login.html" style="color: var(--primary-blue)">
              Back to Login
            </a>
          </div>
        </form>
      </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/nav.js"></script>
    <script>
      function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        if (input.type === "password") {
          input.type = "text";
          btn.textContent = "üîí";
        } else {
          input.type = "password";
          btn.textContent = "üëÅÔ∏è";
        }
      }

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");

      if (!token) {
        document.getElementById("message-container").innerHTML =
          '<div class="error-message">‚ùå Invalid reset link. Please request a new password reset.</div>';
        document.getElementById("form-reset-password").style.display = "none";
      }

      // Handle form submission
      document.getElementById("form-reset-password").onsubmit = async function (
        e
      ) {
        e.preventDefault();

        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        const submitBtn = this.querySelector('button[type="submit"]');
        const messageContainer = document.getElementById("message-container");

        // Clear previous messages
        messageContainer.innerHTML = "";

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          messageContainer.innerHTML =
            '<div class="error-message">‚ùå Passwords do not match</div>';
          return;
        }

        // Validate password length
        if (newPassword.length < 6) {
          messageContainer.innerHTML =
            '<div class="error-message">‚ùå Password must be at least 6 characters</div>';
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Resetting...";

        try {
          const res = await fetch("/api/auth/reset-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: token,
              password: newPassword,
            }),
          });

          const data = await res.json();

          if (res.ok) {
            messageContainer.innerHTML =
              '<div class="success-message">‚úÖ Password reset successfully! Redirecting to login...</div>';
            this.reset();
            setTimeout(() => {
              window.location.href = "login.html";
            }, 2000);
          } else {
            messageContainer.innerHTML = `<div class="error-message">‚ùå ${
              data.error || "Failed to reset password"
            }</div>`;
            submitBtn.disabled = false;
            submitBtn.textContent = "Reset Password";
          }
        } catch (err) {
          messageContainer.innerHTML =
            '<div class="error-message">‚ùå Network error. Please try again.</div>';
          submitBtn.disabled = false;
          submitBtn.textContent = "Reset Password";
        }
      };
    </script>
  </body>
</html>
